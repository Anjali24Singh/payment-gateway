<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtAuthenticationFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">payment-gateway</a> &gt; <a href="index.source.html" class="el_package">com.talentica.paymentgateway.security</a> &gt; <span class="el_source">JwtAuthenticationFilter.java</span></div><h1>JwtAuthenticationFilter.java</h1><pre class="source lang-java linenums">package com.talentica.paymentgateway.security;

import com.talentica.paymentgateway.service.JwtService;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.MDC;
import org.springframework.lang.NonNull;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * JWT Authentication Filter to handle JWT token validation and user authentication.
 * Processes incoming requests and validates JWT tokens from Authorization header.
 * 
 * @author Payment Gateway Team
 * @version 1.0.0
 */
<span class="fc" id="L35">@Slf4j</span>
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    private static final String AUTHORIZATION_HEADER = &quot;Authorization&quot;;
    private static final String BEARER_PREFIX = &quot;Bearer &quot;;
    private static final String CORRELATION_ID_HEADER = &quot;X-Correlation-ID&quot;;
    private static final String CORRELATION_ID_MDC_KEY = &quot;correlationId&quot;;
    
    private final JwtService jwtService;

<span class="fc" id="L46">    public JwtAuthenticationFilter(JwtService jwtService) {</span>
<span class="fc" id="L47">        this.jwtService = jwtService;</span>
<span class="fc" id="L48">    }</span>

    @Override
    protected void doFilterInternal(
            @NonNull HttpServletRequest request,
            @NonNull HttpServletResponse response,
            @NonNull FilterChain filterChain
    ) throws ServletException, IOException {
        try {
            // Set correlation ID for request tracing
<span class="fc" id="L58">            setCorrelationId(request);</span>
            
            // Skip authentication for public endpoints
<span class="fc bfc" id="L61" title="All 2 branches covered.">            if (isPublicEndpoint(request)) {</span>
<span class="fc" id="L62">                filterChain.doFilter(request, response);</span>
<span class="fc" id="L63">                return;</span>
            }

<span class="fc" id="L66">            final String authHeader = request.getHeader(AUTHORIZATION_HEADER);</span>
<span class="fc" id="L67">            log.debug(&quot;Processing request: {} {}, Auth header: {}&quot;, </span>
<span class="fc" id="L68">                        request.getMethod(), request.getRequestURI(), </span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">                        authHeader != null ? &quot;present&quot; : &quot;missing&quot;);</span>
            
            // Check if Authorization header is present and has Bearer token
<span class="fc bfc" id="L72" title="All 2 branches covered.">            if (!StringUtils.hasText(authHeader)) {</span>
<span class="fc" id="L73">                log.debug(&quot;No Authorization header found for: {}&quot;, request.getRequestURI());</span>
                // proceed without authentication
<span class="fc bfc" id="L75" title="All 2 branches covered.">            } else if (!authHeader.startsWith(BEARER_PREFIX)) {</span>
<span class="fc" id="L76">                log.debug(&quot;Authorization header doesn't start with Bearer for: {} - header: {}&quot;, </span>
<span class="fc" id="L77">                           request.getRequestURI(), authHeader);</span>
                // proceed without authentication
            } else {
<span class="fc" id="L80">                final String jwt = authHeader.substring(BEARER_PREFIX.length());</span>
                try {
                    // Extract username from token
<span class="fc" id="L83">                    final String username = jwtService.extractUsername(jwt);</span>
                    
                    // Check if user is not already authenticated
<span class="pc bpc" id="L86" title="2 of 4 branches missed.">                    if (StringUtils.hasText(username) &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) {</span>
                        // Validate if it's an access token
<span class="fc bfc" id="L88" title="All 2 branches covered.">                        if (!jwtService.isAccessToken(jwt)) {</span>
<span class="fc" id="L89">                            log.warn(&quot;Invalid token type provided. Expected access token for user: {}&quot;, username);</span>
                        } else {
                            // Create user details from token
<span class="fc" id="L92">                            UserDetails userDetails = createUserDetailsFromToken(jwt, username);</span>
                            
                            // Validate token
<span class="fc bfc" id="L95" title="All 2 branches covered.">                            if (jwtService.isTokenValid(jwt, userDetails)) {</span>
                                // Create authentication token
<span class="fc" id="L97">                                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(</span>
                                        userDetails,
                                        null,
<span class="fc" id="L100">                                        userDetails.getAuthorities()</span>
                                );
                                
                                // Set authentication details
<span class="fc" id="L104">                                authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));</span>
                                
                                // Set authentication in security context
<span class="fc" id="L107">                                SecurityContextHolder.getContext().setAuthentication(authToken);</span>
                                
                                // Add user information to MDC for logging
<span class="fc" id="L110">                                MDC.put(&quot;username&quot;, username);</span>
<span class="fc" id="L111">                                MDC.put(&quot;userId&quot;, jwtService.extractUserId(jwt));</span>
                                
<span class="fc" id="L113">                                log.info(&quot;Successfully authenticated user: {} for request: {} {}&quot;, </span>
<span class="fc" id="L114">                                          username, request.getMethod(), request.getRequestURI());</span>
<span class="fc" id="L115">                            } else {</span>
<span class="fc" id="L116">                                log.warn(&quot;Invalid JWT token for user: {} on request: {} {}&quot;, </span>
<span class="fc" id="L117">                                          username, request.getMethod(), request.getRequestURI());</span>
                            }
<span class="fc" id="L119">                        }</span>
                    } else {
<span class="nc" id="L121">                        log.debug(&quot;User already authenticated or invalid username in token&quot;);</span>
                    }
<span class="fc" id="L123">                } catch (Exception e) {</span>
<span class="fc" id="L124">                    log.warn(&quot;JWT token validation failed: {}&quot;, e.getMessage());</span>
                    // Continue without authentication - let security context handle unauthorized access
<span class="fc" id="L126">                }</span>
            }
<span class="fc" id="L128">        } catch (Exception e) {</span>
<span class="fc" id="L129">            log.error(&quot;Error processing JWT authentication filter: {}&quot;, e.getMessage(), e);</span>
        } finally {
            // Clean up MDC keys set by this filter
            // Note: do not clear correlationId set by upstream CorrelationIdFilter
<span class="fc" id="L133">            MDC.remove(&quot;username&quot;);</span>
<span class="fc" id="L134">            MDC.remove(&quot;userId&quot;);</span>
        }
        
        // Continue filter chain exactly once
<span class="fc" id="L138">        filterChain.doFilter(request, response);</span>
<span class="fc" id="L139">    }</span>

    /**
     * Set correlation ID for request tracing.
     * 
     * @param request HTTP request
     */
    private void setCorrelationId(HttpServletRequest request) {
<span class="fc" id="L147">        String correlationId = request.getHeader(CORRELATION_ID_HEADER);</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (!StringUtils.hasText(correlationId)) {</span>
<span class="fc" id="L149">            correlationId = UUID.randomUUID().toString();</span>
        }
<span class="fc" id="L151">        MDC.put(CORRELATION_ID_MDC_KEY, correlationId);</span>
<span class="fc" id="L152">    }</span>

    /**
     * Check if the endpoint is public and doesn't require authentication.
     * 
     * @param request HTTP request
     * @return true if public endpoint
     */
    private boolean isPublicEndpoint(HttpServletRequest request) {
<span class="fc" id="L161">        String requestURI = request.getRequestURI();</span>
        
        // List of public endpoints that don't require authentication
<span class="fc" id="L164">        List&lt;String&gt; publicEndpoints = Arrays.asList(</span>
                &quot;/api/v1/auth/login&quot;,
                &quot;/api/v1/auth/register&quot;,
                &quot;/api/v1/auth/refresh&quot;,
                &quot;/api/v1/health&quot;,
                &quot;/api/v1/actuator&quot;,
                &quot;/api/v1/swagger-ui&quot;,
                &quot;/api/v1/api-docs&quot;,
                &quot;/api/v1/webhook&quot;  // Webhook endpoints use different authentication
        );
        
<span class="fc bfc" id="L175" title="All 2 branches covered.">        return publicEndpoints.stream().anyMatch(requestURI::startsWith) ||</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">               requestURI.equals(&quot;/&quot;) ||</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">               requestURI.startsWith(&quot;/actuator/&quot;) ||</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">               requestURI.startsWith(&quot;/swagger-ui/&quot;) ||</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">               requestURI.startsWith(&quot;/api-docs/&quot;);</span>
    }

    /**
     * Create UserDetails from JWT token.
     * 
     * @param jwt JWT token
     * @param username Username
     * @return UserDetails object
     */
    private UserDetails createUserDetailsFromToken(String jwt, String username) {
        try {
            // Extract authorities from token
<span class="fc" id="L192">            String authoritiesString = jwtService.extractAuthorities(jwt);</span>
<span class="fc" id="L193">            List&lt;SimpleGrantedAuthority&gt; authorities = Collections.emptyList();</span>
            
<span class="fc bfc" id="L195" title="All 2 branches covered.">            if (StringUtils.hasText(authoritiesString)) {</span>
                // Parse authorities string (format: [ROLE_USER, ROLE_ADMIN])
<span class="fc" id="L197">                String cleanAuthorities = authoritiesString.replaceAll(&quot;[\\[\\]\\s]&quot;, &quot;&quot;);</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">                if (StringUtils.hasText(cleanAuthorities)) {</span>
<span class="fc" id="L199">                    authorities = Arrays.stream(cleanAuthorities.split(&quot;,&quot;))</span>
<span class="fc" id="L200">                            .filter(StringUtils::hasText)</span>
<span class="fc" id="L201">                            .map(String::trim)</span>
<span class="fc" id="L202">                            .map(SimpleGrantedAuthority::new)</span>
<span class="fc" id="L203">                            .collect(Collectors.toList());</span>
                }
<span class="fc" id="L205">                log.debug(&quot;Parsed authorities for user {}: {}&quot;, username, authorities);</span>
            }
            
            // Default authority if none found
<span class="fc bfc" id="L209" title="All 2 branches covered.">            if (authorities.isEmpty()) {</span>
<span class="fc" id="L210">                authorities = Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_USER&quot;));</span>
            }
            
<span class="fc" id="L213">            return User.builder()</span>
<span class="fc" id="L214">                    .username(username)</span>
<span class="fc" id="L215">                    .password(&quot;&quot;) // Password not needed for JWT authentication</span>
<span class="fc" id="L216">                    .authorities(authorities)</span>
<span class="fc" id="L217">                    .accountExpired(false)</span>
<span class="fc" id="L218">                    .accountLocked(false)</span>
<span class="fc" id="L219">                    .credentialsExpired(false)</span>
<span class="fc" id="L220">                    .disabled(false)</span>
<span class="fc" id="L221">                    .build();</span>
                    
<span class="nc" id="L223">        } catch (Exception e) {</span>
<span class="nc" id="L224">            log.warn(&quot;Error creating user details from token: {}&quot;, e.getMessage());</span>
            // Return basic user with default role
<span class="nc" id="L226">            return User.builder()</span>
<span class="nc" id="L227">                    .username(username)</span>
<span class="nc" id="L228">                    .password(&quot;&quot;)</span>
<span class="nc" id="L229">                    .authorities(Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_USER&quot;)))</span>
<span class="nc" id="L230">                    .build();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>