<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApiKeyAuthenticationFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">payment-gateway</a> &gt; <a href="index.source.html" class="el_package">com.talentica.paymentgateway.security</a> &gt; <span class="el_source">ApiKeyAuthenticationFilter.java</span></div><h1>ApiKeyAuthenticationFilter.java</h1><pre class="source lang-java linenums">package com.talentica.paymentgateway.security;

import com.talentica.paymentgateway.service.ApiKeyService;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.MDC;
import org.springframework.lang.NonNull;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

/**
 * API Key Authentication Filter for external service integrations.
 * Handles API key validation for webhook endpoints and external service calls.
 * 
 * @author Payment Gateway Team
 * @version 1.0.0
 */
<span class="fc" id="L34">@Slf4j</span>
@Component
public class ApiKeyAuthenticationFilter extends OncePerRequestFilter {
    
    private static final String API_KEY_HEADER = &quot;X-API-Key&quot;;
    private static final String API_KEY_PARAM = &quot;api_key&quot;;
    
    private final ApiKeyService apiKeyService;

<span class="fc" id="L43">    public ApiKeyAuthenticationFilter(ApiKeyService apiKeyService) {</span>
<span class="fc" id="L44">        this.apiKeyService = apiKeyService;</span>
<span class="fc" id="L45">    }</span>

    @Override
    protected void doFilterInternal(
            @NonNull HttpServletRequest request,
            @NonNull HttpServletResponse response,
            @NonNull FilterChain filterChain
    ) throws ServletException, IOException {
        
        try {
            // Only process API key authentication for specific endpoints
<span class="fc bfc" id="L56" title="All 2 branches covered.">            if (!requiresApiKeyAuthentication(request)) {</span>
<span class="fc" id="L57">                return;</span>
            }

            // Extract API key from request
<span class="fc" id="L61">            String apiKey = extractApiKey(request);</span>
            
<span class="fc bfc" id="L63" title="All 2 branches covered.">            if (!StringUtils.hasText(apiKey)) {</span>
<span class="fc" id="L64">                log.debug(&quot;No API key found for endpoint: {}&quot;, request.getRequestURI());</span>
<span class="fc" id="L65">                return;</span>
            }

            try {
                // Validate API key
<span class="fc bfc" id="L70" title="All 2 branches covered.">                if (apiKeyService.isValidApiKey(apiKey)) {</span>
                    // Get API key details
<span class="fc" id="L72">                    String clientId = apiKeyService.getClientId(apiKey);</span>
<span class="fc" id="L73">                    List&lt;String&gt; permissions = apiKeyService.getPermissions(apiKey);</span>
                    
                    // Create authentication token with clientId as principal (allows null/empty)
<span class="fc" id="L76">                    List&lt;GrantedAuthority&gt; authorities = new java.util.ArrayList&lt;&gt;();</span>
<span class="fc" id="L77">                    authorities.add(new SimpleGrantedAuthority(&quot;ROLE_API_CLIENT&quot;));</span>
                    
<span class="fc bfc" id="L79" title="All 2 branches covered.">                    if (permissions != null) {</span>
<span class="fc" id="L80">                        permissions.stream()</span>
<span class="fc" id="L81">                                .map(permission -&gt; new SimpleGrantedAuthority(&quot;SCOPE_&quot; + permission))</span>
<span class="fc" id="L82">                                .forEach(authorities::add);</span>
                    }
                    
                    // Create authentication token with clientId as principal
<span class="fc" id="L86">                    UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(</span>
                            clientId, // Use clientId directly as principal
                            apiKey,
                            authorities
                    );
                    
                    // Set authentication details
<span class="fc" id="L93">                    authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));</span>
                    
                    // Set authentication in security context
<span class="fc" id="L96">                    SecurityContextHolder.getContext().setAuthentication(authToken);</span>
                    
                    // Add API key information to MDC for logging
<span class="fc" id="L99">                    MDC.put(&quot;clientId&quot;, clientId);</span>
<span class="fc" id="L100">                    MDC.put(&quot;authType&quot;, &quot;API_KEY&quot;);</span>
                    
<span class="fc" id="L102">                    log.debug(&quot;Successfully authenticated API key for client: {}&quot;, clientId);</span>
<span class="fc" id="L103">                } else {</span>
<span class="fc" id="L104">                    log.warn(&quot;Invalid API key provided for endpoint: {}&quot;, request.getRequestURI());</span>
                }
<span class="fc" id="L106">            } catch (Exception e) {</span>
<span class="fc" id="L107">                log.warn(&quot;API key validation failed: {}&quot;, e.getMessage());</span>
<span class="fc" id="L108">            }</span>
            
<span class="nc" id="L110">        } catch (Exception e) {</span>
<span class="nc" id="L111">            log.error(&quot;Error processing API key authentication filter: {}&quot;, e.getMessage(), e);</span>
        } finally {
            try {
<span class="fc" id="L114">                filterChain.doFilter(request, response);</span>
            } finally {
                // Clean up MDC
<span class="fc" id="L117">                MDC.remove(&quot;clientId&quot;);</span>
<span class="fc" id="L118">                MDC.remove(&quot;authType&quot;);</span>
            }
        }
<span class="fc" id="L121">    }</span>

    /**
     * Check if the endpoint requires API key authentication.
     * 
     * @param request HTTP request
     * @return true if API key authentication is required
     */
    private boolean requiresApiKeyAuthentication(HttpServletRequest request) {
<span class="fc" id="L130">        String requestURI = request.getRequestURI();</span>
        
        // List of endpoints that require API key authentication
<span class="fc" id="L133">        List&lt;String&gt; apiKeyEndpoints = Arrays.asList(</span>
                &quot;/api/v1/webhook&quot;,
                &quot;/api/v1/external&quot;,
                &quot;/api/v1/integration&quot;
        );
        
<span class="fc" id="L139">        return apiKeyEndpoints.stream().anyMatch(requestURI::startsWith);</span>
    }

    /**
     * Extract API key from request headers or parameters.
     * 
     * @param request HTTP request
     * @return API key string or null if not found
     */
    private String extractApiKey(HttpServletRequest request) {
        // First, try to get API key from header
<span class="fc" id="L150">        String apiKey = request.getHeader(API_KEY_HEADER);</span>
        
        // If not in header, try query parameter
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (!StringUtils.hasText(apiKey)) {</span>
<span class="fc" id="L154">            apiKey = request.getParameter(API_KEY_PARAM);</span>
        }
        
<span class="fc" id="L157">        return apiKey;</span>
    }

    /**
     * Create UserDetails for API key authentication.
     * 
     * @param clientId Client identifier
     * @param permissions List of permissions
     * @return UserDetails object
     */
    private UserDetails createApiKeyUserDetails(String clientId, List&lt;String&gt; permissions) {
        // Convert permissions to granted authorities
<span class="nc" id="L169">        List&lt;SimpleGrantedAuthority&gt; authorities = new java.util.ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (permissions != null) {</span>
<span class="nc" id="L172">            permissions.stream()</span>
<span class="nc" id="L173">                    .map(permission -&gt; new SimpleGrantedAuthority(&quot;SCOPE_&quot; + permission))</span>
<span class="nc" id="L174">                    .forEach(authorities::add);</span>
        }
        
        // Add default API key role
<span class="nc" id="L178">        authorities.add(new SimpleGrantedAuthority(&quot;ROLE_API_CLIENT&quot;));</span>
        
        // Handle null or empty clientId gracefully - use placeholder
<span class="nc bnc" id="L181" title="All 4 branches missed.">        String username = (clientId != null &amp;&amp; !clientId.isBlank()) ? clientId : &quot;anonymous&quot;;</span>
        
<span class="nc" id="L183">        return User.builder()</span>
<span class="nc" id="L184">                .username(username)</span>
<span class="nc" id="L185">                .password(&quot;&quot;) // Password not needed for API key authentication</span>
<span class="nc" id="L186">                .authorities(authorities)</span>
<span class="nc" id="L187">                .accountExpired(false)</span>
<span class="nc" id="L188">                .accountLocked(false)</span>
<span class="nc" id="L189">                .credentialsExpired(false)</span>
<span class="nc" id="L190">                .disabled(false)</span>
<span class="nc" id="L191">                .build();</span>
    }

    /**
     * Check if filter should not be applied to this request.
     * 
     * @param request HTTP request
     * @return true if filter should be skipped
     */
    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        // Only apply to specific endpoints that require API key authentication
<span class="fc bfc" id="L203" title="All 2 branches covered.">        return !requiresApiKeyAuthentication(request);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>