<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnalyticsController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">payment-gateway</a> &gt; <a href="index.source.html" class="el_package">com.talentica.paymentgateway.controller</a> &gt; <span class="el_source">AnalyticsController.java</span></div><h1>AnalyticsController.java</h1><pre class="source lang-java linenums">package com.talentica.paymentgateway.controller;

import com.talentica.paymentgateway.dto.DashboardOverviewResponse;
import com.talentica.paymentgateway.dto.analytics.*;
import com.talentica.paymentgateway.dto.metrics.DashboardMetrics;
import com.talentica.paymentgateway.service.AnalyticsService;
import com.talentica.paymentgateway.service.MetricsService;
import com.talentica.paymentgateway.util.CorrelationIdUtil;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.time.ZonedDateTime;
import java.util.Arrays;

/**
 * REST Controller for analytics and reporting operations.
 * 
 * Provides comprehensive analytics endpoints including:
 * - Transaction reporting with filtering and export capabilities
 * - Real-time analytics dashboard metrics
 * - Revenue tracking and subscription performance
 * - Failed payment analysis and fraud detection
 * - Compliance reporting for audit and regulatory requirements
 * 
 * All endpoints support real-time data and include comprehensive filtering options.
 * 
 * @author Payment Gateway Team
 * @version 1.0.0
 */
<span class="fc" id="L43">@Slf4j</span>
@RestController
@RequestMapping(&quot;/analytics&quot;)
@Tag(name = &quot;Analytics &amp; Reporting&quot;, description = &quot;Business intelligence and reporting operations&quot;)
@SecurityRequirement(name = &quot;Bearer Authentication&quot;)
@ConditionalOnProperty(name = &quot;app.features.analytics&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)
public class AnalyticsController {

    private final AnalyticsService analyticsService;
    private final MetricsService metricsService;

<span class="fc" id="L54">    public AnalyticsController(AnalyticsService analyticsService, MetricsService metricsService) {</span>
<span class="fc" id="L55">        this.analyticsService = analyticsService;</span>
<span class="fc" id="L56">        this.metricsService = metricsService;</span>
<span class="fc" id="L57">    }</span>

    /**
     * Get basic dashboard overview.
     */
    @GetMapping(&quot;/dashboard&quot;)
    @Operation(
        summary = &quot;Get dashboard overview&quot;,
        description = &quot;Provides basic dashboard overview with key metrics&quot;
    )
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST') or hasRole('USER')&quot;)
    public ResponseEntity&lt;DashboardOverviewResponse&gt; getDashboardOverview() {
<span class="fc" id="L69">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L70">        log.info(&quot;Dashboard overview request - CorrelationId: {}&quot;, correlationId);</span>
        
        // Return basic dashboard data
<span class="fc" id="L73">        DashboardOverviewResponse response = DashboardOverviewResponse.builder()</span>
<span class="fc" id="L74">                .message(&quot;Dashboard overview&quot;)</span>
<span class="fc" id="L75">                .totalTransactions(0)</span>
<span class="fc" id="L76">                .totalRevenue(java.math.BigDecimal.ZERO)</span>
<span class="fc" id="L77">                .activeSubscriptions(0)</span>
<span class="fc" id="L78">                .build();</span>
        
<span class="fc" id="L80">        return ResponseEntity.ok()</span>
<span class="fc" id="L81">                           .header(&quot;X-Correlation-ID&quot;, correlationId)</span>
<span class="fc" id="L82">                           .body(response);</span>
    }

    /**
     * Generate comprehensive transaction report with filtering and export capabilities.
     */
    @PostMapping(&quot;/reports/transactions&quot;)
    @Operation(
        summary = &quot;Generate transaction report&quot;,
        description = &quot;Creates a comprehensive transaction report with advanced filtering, aggregations, and export options. &quot; +
                     &quot;Supports pagination, time series data, and multiple export formats (JSON, CSV, PDF).&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Transaction report generated successfully&quot;,
                    content = @Content(schema = @Schema(implementation = TransactionReportResponse.class))),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid request parameters&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Insufficient permissions&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST') or hasRole('USER')&quot;)
    public ResponseEntity&lt;TransactionReportResponse&gt; generateTransactionReport(
            @Valid @RequestBody TransactionReportRequest request) {
        
<span class="fc" id="L106">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L107">        log.info(&quot;Transaction report request - CorrelationId: {}, Period: {} to {}&quot;, </span>
<span class="fc" id="L108">                   correlationId, request.getStartDate(), request.getEndDate());</span>

        // Record metrics
<span class="fc" id="L111">        metricsService.recordAnalyticsRequest(&quot;transaction_report&quot;);</span>

<span class="fc" id="L113">        TransactionReportResponse response = analyticsService.generateTransactionReport(request);</span>

<span class="fc" id="L115">        log.info(&quot;Transaction report generated - CorrelationId: {}, Records: {}&quot;, </span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">                   correlationId, response.getMetadata() != null ? response.getMetadata().getTotalRecords() : 0);</span>

<span class="fc" id="L118">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Get real-time analytics dashboard metrics.
     */
    @PostMapping(&quot;/dashboard&quot;)
    @Operation(
        summary = &quot;Get analytics dashboard metrics&quot;,
        description = &quot;Retrieves real-time analytics dashboard metrics including transaction volumes, &quot; +
                     &quot;revenue tracking, subscription performance, and key business indicators.&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Dashboard metrics retrieved successfully&quot;,
                    content = @Content(schema = @Schema(implementation = DashboardMetrics.class))),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid request parameters&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Insufficient permissions&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST') or hasRole('USER')&quot;)
    public ResponseEntity&lt;DashboardMetrics&gt; getDashboardMetrics(
            @Valid @RequestBody AnalyticsDashboardRequest request) {
        
<span class="fc" id="L142">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L143">        log.info(&quot;Dashboard metrics request - CorrelationId: {}, Period: {} to {}&quot;, </span>
<span class="fc" id="L144">                   correlationId, request.getStartDate(), request.getEndDate());</span>

        // Record metrics
<span class="fc" id="L147">        metricsService.recordAnalyticsRequest(&quot;dashboard&quot;);</span>

<span class="fc" id="L149">        DashboardMetrics metrics = analyticsService.generateDashboardMetrics(request);</span>

<span class="fc" id="L151">        log.info(&quot;Dashboard metrics generated - CorrelationId: {}&quot;, correlationId);</span>

<span class="fc" id="L153">        return ResponseEntity.ok(metrics);</span>
    }

    /**
     * Get quick dashboard metrics for a predefined time period.
     */
    @GetMapping(&quot;/dashboard/quick&quot;)
    @Operation(
        summary = &quot;Get quick dashboard metrics&quot;,
        description = &quot;Retrieves dashboard metrics for common time periods (24h, 7d, 30d, 90d) &quot; +
                     &quot;with predefined configurations for rapid dashboard loading.&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Quick metrics retrieved successfully&quot;),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid period parameter&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST') or hasRole('USER')&quot;)
    public ResponseEntity&lt;DashboardMetrics&gt; getQuickDashboardMetrics(
            @Parameter(description = &quot;Time period (24h, 7d, 30d, 90d)&quot;, example = &quot;30d&quot;)
            @RequestParam(defaultValue = &quot;30d&quot;) String period) {
        
<span class="fc" id="L176">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L177">        log.info(&quot;Quick dashboard metrics request - CorrelationId: {}, Period: {}&quot;, correlationId, period);</span>

        // Parse period and create request
<span class="fc" id="L180">        AnalyticsDashboardRequest request = createQuickDashboardRequest(period);</span>
        
        // Record metrics
<span class="fc" id="L183">        metricsService.recordAnalyticsRequest(&quot;dashboard_quick&quot;);</span>

<span class="fc" id="L185">        DashboardMetrics metrics = analyticsService.generateDashboardMetrics(request);</span>

<span class="fc" id="L187">        log.info(&quot;Quick dashboard metrics generated - CorrelationId: {}&quot;, correlationId);</span>

<span class="fc" id="L189">        return ResponseEntity.ok(metrics);</span>
    }

    /**
     * Analyze failed payments and detect fraud patterns.
     */
    @GetMapping(&quot;/failed-payments&quot;)
    @Operation(
        summary = &quot;Analyze failed payments&quot;,
        description = &quot;Provides comprehensive analysis of failed payments including error patterns, &quot; +
                     &quot;fraud detection, geographic trends, and actionable recommendations for improvement.&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Failed payment analysis completed&quot;,
                    content = @Content(schema = @Schema(implementation = FailedPaymentAnalysis.class))),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid date parameters&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Insufficient permissions&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST') or hasRole('USER')&quot;)
    public ResponseEntity&lt;FailedPaymentAnalysis&gt; analyzeFailedPayments(
            @Parameter(description = &quot;Analysis start date&quot;, example = &quot;2025-01-01T00:00:00Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime startDate,
            @Parameter(description = &quot;Analysis end date&quot;, example = &quot;2025-01-31T23:59:59Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime endDate) {
        
<span class="fc" id="L216">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L217">        log.info(&quot;Failed payment analysis request - CorrelationId: {}, Period: {} to {}&quot;, </span>
                   correlationId, startDate, endDate);

        // Record metrics
<span class="fc" id="L221">        metricsService.recordAnalyticsRequest(&quot;failed_payment_analysis&quot;);</span>

<span class="fc" id="L223">        FailedPaymentAnalysis analysis = analyticsService.analyzeFailedPayments(startDate, endDate);</span>

<span class="fc" id="L225">        log.info(&quot;Failed payment analysis completed - CorrelationId: {}, Failed: {}&quot;, </span>
<span class="fc" id="L226">                   correlationId, analysis.getTotalFailedPayments());</span>

<span class="fc" id="L228">        return ResponseEntity.ok(analysis);</span>
    }

    /**
     * Generate compliance report for audit and regulatory requirements.
     */
    @GetMapping(&quot;/compliance/{reportType}&quot;)
    @Operation(
        summary = &quot;Generate compliance report&quot;,
        description = &quot;Creates comprehensive compliance reports for audit and regulatory requirements. &quot; +
                     &quot;Supports multiple report types including PCI DSS, GDPR, SOX, and general audit reports.&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Compliance report generated successfully&quot;,
                    content = @Content(schema = @Schema(implementation = ComplianceReport.class))),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid report type or date parameters&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Insufficient permissions&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('COMPLIANCE_OFFICER')&quot;)
    public ResponseEntity&lt;ComplianceReport&gt; generateComplianceReport(
            @Parameter(description = &quot;Report type (AUDIT, PCI_DSS, GDPR, SOX)&quot;, example = &quot;PCI_DSS&quot;)
            @PathVariable String reportType,
            @Parameter(description = &quot;Report start date&quot;, example = &quot;2025-01-01T00:00:00Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime startDate,
            @Parameter(description = &quot;Report end date&quot;, example = &quot;2025-01-31T23:59:59Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime endDate) {
        
<span class="fc" id="L257">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L258">        log.info(&quot;Compliance report request - CorrelationId: {}, Type: {}, Period: {} to {}&quot;, </span>
                   correlationId, reportType, startDate, endDate);

        // Validate report type
<span class="fc bfc" id="L262" title="All 2 branches covered.">        if (!isValidReportType(reportType)) {</span>
<span class="fc" id="L263">            return ResponseEntity.badRequest().build();</span>
        }

        // Record metrics
<span class="fc" id="L267">        metricsService.recordAnalyticsRequest(&quot;compliance_report&quot;);</span>

<span class="fc" id="L269">        ComplianceReport report = analyticsService.generateComplianceReport(reportType, startDate, endDate);</span>

<span class="fc" id="L271">        log.info(&quot;Compliance report generated - CorrelationId: {}, Type: {}&quot;, correlationId, reportType);</span>

<span class="fc" id="L273">        return ResponseEntity.ok(report);</span>
    }

    /**
     * Get revenue analytics with advanced metrics.
     */
    @GetMapping(&quot;/revenue&quot;)
    @Operation(
        summary = &quot;Get revenue analytics&quot;,
        description = &quot;Provides comprehensive revenue analytics including total revenue, recurring revenue, &quot; +
                     &quot;refunds, net revenue, and growth trends with comparative analysis.&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Revenue analytics retrieved successfully&quot;),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid date parameters&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Insufficient permissions&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST') or hasRole('FINANCE') or hasRole('USER')&quot;)
    public ResponseEntity&lt;?&gt; getRevenueAnalytics(
            @Parameter(description = &quot;Analysis start date&quot;, example = &quot;2025-01-01T00:00:00Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime startDate,
            @Parameter(description = &quot;Analysis end date&quot;, example = &quot;2025-01-31T23:59:59Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime endDate,
            @Parameter(description = &quot;Include comparative analysis&quot;, example = &quot;true&quot;)
            @RequestParam(defaultValue = &quot;false&quot;) boolean includeComparison) {
        
<span class="fc" id="L301">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L302">        log.info(&quot;Revenue analytics request - CorrelationId: {}, Period: {} to {}&quot;, </span>
                   correlationId, startDate, endDate);

        // Record metrics
<span class="fc" id="L306">        metricsService.recordAnalyticsRequest(&quot;revenue_analytics&quot;);</span>

        // Generate revenue metrics
<span class="fc" id="L309">        var revenueMetrics = analyticsService.generateRevenueMetrics(startDate, endDate);</span>

<span class="fc" id="L311">        log.info(&quot;Revenue analytics generated - CorrelationId: {}&quot;, correlationId);</span>

<span class="fc" id="L313">        return ResponseEntity.ok(revenueMetrics);</span>
    }

    /**
     * Get subscription performance analytics.
     */
    @GetMapping(&quot;/subscriptions&quot;)
    @Operation(
        summary = &quot;Get subscription analytics&quot;,
        description = &quot;Provides detailed subscription performance analytics including churn rates, &quot; +
                     &quot;MRR growth, plan performance, and customer lifecycle metrics.&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Subscription analytics retrieved successfully&quot;),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid date parameters&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Insufficient permissions&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST') or hasRole('USER')&quot;)
    public ResponseEntity&lt;?&gt; getSubscriptionAnalytics(
            @Parameter(description = &quot;Analysis start date&quot;, example = &quot;2025-01-01T00:00:00Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime startDate,
            @Parameter(description = &quot;Analysis end date&quot;, example = &quot;2025-01-31T23:59:59Z&quot;)
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) ZonedDateTime endDate) {
        
<span class="fc" id="L339">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L340">        log.info(&quot;Subscription analytics request - CorrelationId: {}, Period: {} to {}&quot;, </span>
                   correlationId, startDate, endDate);

        // Record metrics
<span class="fc" id="L344">        metricsService.recordAnalyticsRequest(&quot;subscription_analytics&quot;);</span>

        // Generate subscription metrics
<span class="fc" id="L347">        var subscriptionMetrics = analyticsService.generateSubscriptionMetrics(startDate, endDate);</span>

<span class="fc" id="L349">        log.info(&quot;Subscription analytics generated - CorrelationId: {}&quot;, correlationId);</span>

<span class="fc" id="L351">        return ResponseEntity.ok(subscriptionMetrics);</span>
    }

    /**
     * Export analytics data in various formats.
     */
    @PostMapping(&quot;/export&quot;)
    @Operation(
        summary = &quot;Export analytics data&quot;,
        description = &quot;Exports analytics data in various formats (CSV, PDF, Excel) with customizable content and filtering.&quot;
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Export initiated successfully&quot;),
        @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid export parameters&quot;),
        @ApiResponse(responseCode = &quot;401&quot;, description = &quot;Authentication required&quot;),
        @ApiResponse(responseCode = &quot;403&quot;, description = &quot;Insufficient permissions&quot;),
        @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    @PreAuthorize(&quot;hasRole('ADMIN') or hasRole('ANALYST')&quot;)
    public ResponseEntity&lt;?&gt; exportAnalyticsData(
            @Valid @RequestBody TransactionReportRequest request) {
        
<span class="fc" id="L373">        String correlationId = CorrelationIdUtil.getOrGenerate();</span>
<span class="fc" id="L374">        log.info(&quot;Analytics export request - CorrelationId: {}, Format: {}&quot;, </span>
<span class="fc" id="L375">                   correlationId, request.getExportFormat());</span>

        // Record metrics
<span class="fc" id="L378">        metricsService.recordAnalyticsRequest(&quot;export&quot;);</span>

        // Generate export (this would typically be an async operation)
<span class="fc" id="L381">        TransactionReportResponse response = analyticsService.generateTransactionReport(request);</span>

<span class="fc" id="L383">        log.info(&quot;Analytics export completed - CorrelationId: {}&quot;, correlationId);</span>

<span class="fc" id="L385">        return ResponseEntity.ok(response.getExportInfo());</span>
    }

    // Helper methods

    private AnalyticsDashboardRequest createQuickDashboardRequest(String period) {
<span class="fc" id="L391">        ZonedDateTime now = ZonedDateTime.now();</span>
        ZonedDateTime startDate;

<span class="pc bpc" id="L394" title="2 of 5 branches missed.">        switch (period) {</span>
            case &quot;24h&quot;:
<span class="fc" id="L396">                startDate = now.minusDays(1);</span>
<span class="fc" id="L397">                break;</span>
            case &quot;7d&quot;:
<span class="fc" id="L399">                startDate = now.minusDays(7);</span>
<span class="fc" id="L400">                break;</span>
            case &quot;30d&quot;:
<span class="fc" id="L402">                startDate = now.minusDays(30);</span>
<span class="fc" id="L403">                break;</span>
            case &quot;90d&quot;:
<span class="nc" id="L405">                startDate = now.minusDays(90);</span>
<span class="nc" id="L406">                break;</span>
            default:
<span class="nc" id="L408">                startDate = now.minusDays(30); // Default to 30 days</span>
        }

<span class="fc" id="L411">        AnalyticsDashboardRequest request = new AnalyticsDashboardRequest(startDate, now);</span>
<span class="fc" id="L412">        request.setIncludeRealTime(true);</span>
<span class="fc" id="L413">        request.setIncludeBreakdowns(true);</span>
<span class="fc" id="L414">        request.setResolution(determineResolution(period));</span>

<span class="fc" id="L416">        return request;</span>
    }

    private String determineResolution(String period) {
<span class="pc bpc" id="L420" title="1 of 4 branches missed.">        switch (period) {</span>
            case &quot;24h&quot;:
<span class="fc" id="L422">                return &quot;HOUR&quot;;</span>
            case &quot;7d&quot;:
<span class="fc" id="L424">                return &quot;DAY&quot;;</span>
            case &quot;30d&quot;:
            case &quot;90d&quot;:
<span class="fc" id="L427">                return &quot;DAY&quot;;</span>
            default:
<span class="nc" id="L429">                return &quot;DAY&quot;;</span>
        }
    }

    private boolean isValidReportType(String reportType) {
<span class="fc" id="L434">        return Arrays.asList(&quot;AUDIT&quot;, &quot;PCI_DSS&quot;, &quot;GDPR&quot;, &quot;SOX&quot;, &quot;SECURITY&quot;, &quot;FINANCIAL&quot;)</span>
<span class="fc" id="L435">                .contains(reportType.toUpperCase());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>