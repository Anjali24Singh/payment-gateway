# ğŸš€ Payment Gateway Platform - Docker Compose Configuration
# Complete development and production-ready environment setup
# 
# Features:
# - ğŸ—„ï¸ PostgreSQL 15 with optimized configuration
# - ğŸ”„ Redis 7 for caching and session management  
# - ğŸ“Š Prometheus + Grafana monitoring stack
# - ğŸ” Zipkin distributed tracing
# - ğŸ›¡ï¸ Production-ready security settings
# - ğŸ“ˆ Performance optimized configurations
# - â¤ï¸ Health checks for all services
# - ğŸ”§ Development and production profiles

version: '3.8'

# ğŸ·ï¸ Service Labels for Organization
x-labels: &default-labels
  com.talentica.project: "payment-gateway"
  com.talentica.environment: "${ENV:-development}"
  com.talentica.version: "${VERSION:-1.0.0}"

# ğŸ”§ Common Environment Variables
x-common-variables: &common-variables
  TZ: UTC
  LOGGING_LEVEL_ROOT: INFO

# ğŸ”„ Restart Policy
x-restart-policy: &restart-policy
  restart: unless-stopped

services:
  # ğŸ—„ï¸ PostgreSQL Database - Primary Data Store
  postgres:
    image: postgres:15.6-alpine
    container_name: payment-gateway-postgres
    hostname: payment-postgres
    labels:
      <<: *default-labels
      com.talentica.service: "database"
      com.talentica.tier: "data"
    environment:
      <<: *common-variables
      POSTGRES_DB: ${DB_NAME:-payment_gateway}
      POSTGRES_USER: ${DB_USERNAME:-payment_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-P@yment_Secure_2025!}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
      # Performance optimizations
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB
      POSTGRES_WORK_MEM: 4MB
      POSTGRES_MAX_CONNECTIONS: 100
      POSTGRES_RANDOM_PAGE_COST: 1.1
    ports:
      - "${DB_PORT:-5433}:5432"
    volumes:
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data
      # Database initialization scripts
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro
      # Custom PostgreSQL configuration
      - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      # Backup directory
      - ./backups/postgres:/backups
    networks:
      payment-gateway-network:
        aliases:
          - database
          - db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-payment_user} -d ${DB_NAME:-payment_gateway} -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    <<: *restart-policy

  # ğŸ”„ Redis Cache & Session Store
  redis:
    image: redis:7.2.4-alpine
    container_name: payment-gateway-redis
    hostname: payment-redis
    labels:
      <<: *default-labels
      com.talentica.service: "cache"
      com.talentica.tier: "cache"
    environment:
      <<: *common-variables
      REDIS_PASSWORD: ${REDIS_PASSWORD:-R3dis_Secure_2025!}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      # Persistent cache data
      - redis_data:/data
      # Custom Redis configuration
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      # Redis logs
      - redis_logs:/var/log/redis
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --requirepass ${REDIS_PASSWORD:-R3dis_Secure_2025!}
      --appendonly yes
      --save 900 1
      --save 300 10
      --save 60 10000
    networks:
      payment-gateway-network:
        aliases:
          - cache
          - session-store
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-R3dis_Secure_2025!}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    <<: *restart-policy

  # ğŸš€ Payment Gateway Application - Main Service
  payment-gateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_VERSION: ${VERSION:-1.0.0}
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP}
    image: payment-gateway:${VERSION:-latest}
    container_name: payment-gateway-app
    hostname: payment-app
    labels:
      <<: *default-labels
      com.talentica.service: "payment-gateway"
      com.talentica.tier: "application"
    environment:
      <<: *common-variables
      # Spring Profiles
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES:-docker,monitoring}
      
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-payment_gateway}
      DB_USERNAME: ${DB_USERNAME:-payment_user}
      DB_PASSWORD: ${DB_PASSWORD:-P@yment_Secure_2025!}
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-R3dis_Secure_2025!}
      
      # Security Configuration
      JWT_SECRET: ${JWT_SECRET:-payment-gateway-super-secret-jwt-key-for-production-2025}
      API_KEY_ENCRYPTION: ${API_KEY_ENCRYPTION:-api-key-encryption-secret-2025}
      
      # Authorize.Net Configuration
      AUTHNET_API_LOGIN_ID: ${AUTHNET_API_LOGIN_ID}
      AUTHNET_TRANSACTION_KEY: ${AUTHNET_TRANSACTION_KEY}
      AUTHNET_ENVIRONMENT: ${AUTHNET_ENVIRONMENT:-SANDBOX}
      
      # Observability Configuration
      ZIPKIN_BASE_URL: http://zipkin:9411
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: true
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: true
      
      # Performance Configuration
      SERVER_TOMCAT_MAX_THREADS: 200
      SERVER_TOMCAT_MIN_SPARE_THREADS: 10
      HIKARI_MAXIMUM_POOL_SIZE: 20
      HIKARI_MINIMUM_IDLE: 5
      
      # Logging Configuration
      LOGGING_LEVEL_COM_TALENTICA: ${LOG_LEVEL:-INFO}
      LOGGING_FILE_NAME: /app/logs/payment-gateway.log
      
    ports:
      - "${APP_PORT:-8080}:8080"
      - "${MANAGEMENT_PORT:-8081}:8081"  # Management/Actuator port
    volumes:
      # Application logs
      - app_logs:/app/logs
      # Application configuration
      - ./config:/app/config:ro
      # SSL certificates (if needed)
      - ./ssl:/app/ssl:ro
    networks:
      payment-gateway-network:
        aliases:
          - app
          - payment-api
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health/readiness"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    <<: *restart-policy

  # ğŸ” Zipkin - Distributed Tracing
  zipkin:
    image: openzipkin/zipkin:3.0.6
    container_name: payment-gateway-zipkin
    hostname: payment-zipkin
    labels:
      <<: *default-labels
      com.talentica.service: "tracing"
      com.talentica.tier: "observability"
    environment:
      <<: *common-variables
      STORAGE_TYPE: elasticsearch
      ES_HOSTS: http://elasticsearch:9200
      ES_INDEX: zipkin
      JAVA_OPTS: -Xms256m -Xmx512m
    ports:
      - "${ZIPKIN_PORT:-9411}:9411"
    networks:
      payment-gateway-network:
        aliases:
          - tracing
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9411/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 256M
    <<: *restart-policy

  # ğŸ“Š Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: payment-gateway-prometheus
    hostname: payment-prometheus
    labels:
      <<: *default-labels
      com.talentica.service: "metrics"
      com.talentica.tier: "observability"
    environment:
      <<: *common-variables
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      # Prometheus configuration
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/prometheus/rules:/etc/prometheus/rules:ro
      # Persistent metrics data
      - prometheus_data:/prometheus
      # Alert manager configuration
      - ./docker/prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--storage.tsdb.retention.size=10GB'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--log.level=info'
    networks:
      payment-gateway-network:
        aliases:
          - metrics
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.2'
          memory: 256M
    <<: *restart-policy

  # ğŸ“ˆ Grafana - Metrics Visualization & Dashboards
  grafana:
    image: grafana/grafana:10.3.3
    container_name: payment-gateway-grafana
    hostname: payment-grafana
    labels:
      <<: *default-labels
      com.talentica.service: "dashboards"
      com.talentica.tier: "observability"
    environment:
      <<: *common-variables
      # Security Configuration
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-Gr@fana_2025!}
      GF_SECURITY_SECRET_KEY: ${GRAFANA_SECRET_KEY:-grafana-secret-key-2025}
      
      # Server Configuration
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_SERVER_SERVE_FROM_SUB_PATH: false
      
      # Users Configuration
      GF_USERS_ALLOW_SIGN_UP: false
      GF_USERS_ALLOW_ORG_CREATE: false
      GF_USERS_AUTO_ASSIGN_ORG: true
      GF_USERS_AUTO_ASSIGN_ORG_ROLE: Viewer
      
      # Authentication Configuration
      GF_AUTH_ANONYMOUS_ENABLED: false
      GF_AUTH_BASIC_ENABLED: true
      
      # Database Configuration (using PostgreSQL)
      GF_DATABASE_TYPE: postgres
      GF_DATABASE_HOST: postgres:5432
      GF_DATABASE_NAME: ${DB_NAME:-payment_gateway}
      GF_DATABASE_USER: ${DB_USERNAME:-payment_user}
      GF_DATABASE_PASSWORD: ${DB_PASSWORD:-P@yment_Secure_2025!}
      
      # Install plugins
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-worldmap-panel,grafana-clock-panel
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      # Grafana data persistence
      - grafana_data:/var/lib/grafana
      # Dashboard provisioning
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
      # Custom grafana.ini
      - ./docker/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
    networks:
      payment-gateway-network:
        aliases:
          - dashboards
          - monitoring
    depends_on:
      - prometheus
      - postgres
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    <<: *restart-policy

  # ğŸ” Elasticsearch - Log Storage (Optional)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    container_name: payment-gateway-elasticsearch
    hostname: payment-elasticsearch
    labels:
      <<: *default-labels
      com.talentica.service: "search-engine"
      com.talentica.tier: "data"
    environment:
      <<: *common-variables
      discovery.type: single-node
      xpack.security.enabled: false
      ES_JAVA_OPTS: "-Xmx512m -Xms512m"
      bootstrap.memory_lock: true
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      payment-gateway-network:
        aliases:
          - search
          - logs-storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200/_health"]
      interval: 30s
      timeout: 10s
      retries: 3
    ulimits:
      memlock:
        soft: -1
        hard: -1
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M
    profiles: ["logging", "full"]
    <<: *restart-policy

  # ğŸ“Š AlertManager - Alert Management (Optional)
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: payment-gateway-alertmanager
    hostname: payment-alertmanager
    labels:
      <<: *default-labels
      com.talentica.service: "alerts"
      com.talentica.tier: "observability"
    environment:
      <<: *common-variables
    ports:
      - "${ALERTMANAGER_PORT:-9093}:9093"
    volumes:
      - ./docker/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
      - '--log.level=info'
    networks:
      payment-gateway-network:
        aliases:
          - alerts
    profiles: ["monitoring", "full"]
    <<: *restart-policy

# ğŸ“¦ Named Volumes for Data Persistence
volumes:
  postgres_data:
    driver: local
    labels:
      <<: *default-labels
      com.talentica.volume: "database-data"
  redis_data:
    driver: local
    labels:
      <<: *default-labels
      com.talentica.volume: "cache-data"
  redis_logs:
    driver: local
  app_logs:
    driver: local
    labels:
      <<: *default-labels
      com.talentica.volume: "application-logs"
  prometheus_data:
    driver: local
    labels:
      <<: *default-labels
      com.talentica.volume: "metrics-data"
  grafana_data:
    driver: local
    labels:
      <<: *default-labels
      com.talentica.volume: "dashboard-data"
  elasticsearch_data:
    driver: local
    labels:
      <<: *default-labels
      com.talentica.volume: "search-data"
  alertmanager_data:
    driver: local

# ğŸŒ Custom Networks for Service Communication
networks:
  payment-gateway-network:
    driver: bridge
    labels:
      <<: *default-labels
      com.talentica.network: "payment-gateway"
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: payment-gateway-bridge
      com.docker.network.driver.mtu: 1500
